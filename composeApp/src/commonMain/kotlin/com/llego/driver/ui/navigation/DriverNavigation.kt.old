package com.llego.driver.ui.navigation

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.navigation.NavDestination.Companion.hierarchy
import androidx.navigation.NavGraph.Companion.findStartDestination
import androidx.navigation.NavType
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.navigation.navArgument
import com.llego.shared.ui.navigation.*
import com.llego.shared.ui.theme.LlegoDriverTheme
import com.llego.driver.ui.screens.DriverProfileScreen

/**
 * Sistema de navegación específico para la app de choferes/mensajeros
 * Incluye bottom navigation y manejo de pantallas principales
 */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DriverAppNavigation(
    navigationController: LlegoNavigationController,
    startDestination: String = Routes.Auth.LOGIN
) {
    LlegoDriverTheme {
        var currentRoute by remember { mutableStateOf(startDestination) }
        val navBackStackEntry by navigationController.navController.currentBackStackEntryAsState()
        val currentDestination = navBackStackEntry?.destination

        // Actualizar la ruta actual
        LaunchedEffect(currentDestination) {
            currentDestination?.route?.let { route ->
                currentRoute = route
            }
        }

        // Determinar si mostrar bottom navigation
        val showBottomBar = currentRoute !in listOf(
            Routes.Auth.LOGIN,
            Routes.Auth.FORGOT_PASSWORD,
            Routes.Auth.VERIFY_CODE,
            Routes.Auth.RESET_PASSWORD
        )

        Scaffold(
            bottomBar = {
                if (showBottomBar) {
                    DriverBottomNavigation(
                        navigationController = navigationController,
                        currentDestination = currentDestination
                    )
                }
            }
        ) { paddingValues ->
            NavHost(
                navController = navigationController.navController,
                startDestination = startDestination,
                modifier = Modifier.padding(paddingValues)
            ) {
                // Rutas de autenticación
                composable(Routes.Auth.LOGIN) {
                    // TODO: Implementar LoginScreen
                    PlaceholderScreen("Login Driver")
                }

                // Rutas principales de choferes
                composable(Routes.Driver.DASHBOARD) {
                    // TODO: Implementar DriverDashboardScreen
                    PlaceholderScreen("Driver Dashboard")
                }

                composable(Routes.Driver.ORDERS) {
                    // TODO: Implementar DriverOrdersScreen
                    PlaceholderScreen("Driver Orders")
                }

                composable(Routes.Driver.ORDER_DETAIL) {
                    // TODO: Implementar DriverOrderDetailScreen con navegacion correcta
                    PlaceholderScreen("Order Detail")
                }

                composable(Routes.Driver.MAP) {
                    // TODO: Implementar DriverMapScreen
                    PlaceholderScreen("Driver Map")
                }

                composable(Routes.Driver.DELIVERY_TRACKING) {
                    // TODO: Implementar DeliveryTrackingScreen con navegacion correcta
                    PlaceholderScreen("Delivery Tracking")
                }

                composable(Routes.Driver.PROFILE) {
                    DriverProfileScreen(
                        onLogout = {
                            navigationController.handleLogout()
                        }
                    )
                }

                composable(Routes.Driver.SETTINGS) {
                    // TODO: Implementar DriverSettingsScreen
                    PlaceholderScreen("Driver Settings")
                }

                composable(Routes.Driver.HISTORY) {
                    // TODO: Implementar DriverHistoryScreen
                    PlaceholderScreen("Driver History")
                }

                composable(Routes.Driver.NOTIFICATIONS) {
                    // TODO: Implementar DriverNotificationsScreen
                    PlaceholderScreen("Driver Notifications")
                }
            }
        }
    }
}

@Composable
fun DriverBottomNavigation(
    navigationController: LlegoNavigationController,
    currentDestination: androidx.navigation.NavDestination?
) {
    NavigationBar {
        NavigationItems.driverItems.forEach { item ->
            NavigationBarItem(
                icon = {
                    // TODO: Reemplazar con iconos reales
                    Text(item.iconResId)
                },
                label = { Text(item.labelResId) },
                selected = currentDestination?.hierarchy?.any { it.route == item.route } == true,
                onClick = {
                    navigationController.navController.navigate(item.route) {
                        // Pop up to the start destination of the graph to
                        // avoid building up a large stack of destinations
                        // on the back stack as users select items
                        popUpTo(navigationController.navController.graph.findStartDestination().id) {
                            saveState = true
                        }
                        // Avoid multiple copies of the same destination when
                        // reselecting the same item
                        launchSingleTop = true
                        // Restore state when reselecting a previously selected item
                        restoreState = true
                    }
                }
            )
        }
    }
}

@Composable
fun PlaceholderScreen(title: String) {
    Box(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = title,
            style = MaterialTheme.typography.headlineMedium,
            color = MaterialTheme.colorScheme.onBackground
        )
    }
}